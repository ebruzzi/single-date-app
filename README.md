Single Delivery Date Enforcement – Full Technical Brief (Windows 11 / VS Code)
1. Business Context (Why This Exists)
Store sells exactly one product: a 2kg box of cherries.
Delivery date is represented as a product variant (each variant = a specific date).
Operational rule: A customer must not check out with multiple different delivery date variants in one order (they must place separate orders per date).
Inventory per date is controlled by variant stock. We need hard prevention of “mixed date” carts, not just a warning.

2. Current State (Theme Only)
Already implemented in the theme (front‑end only / bypassable):

custom.js module SingleDeliveryDateEnforcer:
Blocks adding a second variant (different date) of the target product handle (currently mr-henrycherries-2kg).
Adds cart warning + disables checkout buttons if a conflict is detected.
Still bypassable (DevTools edits, direct /cart/add.js calls, Storefront API).
Already created but INERT:

Folder: single-delivery-date-cart-transform
Contains a cart_transform function scaffold (JS runtime) that would prune extra variants.
Not active because the repo is a pure theme—Shopify Functions only run inside an APP project.
3. Goal
Add server-side enforcement so mixed-date carts are impossible:

Cart Transform Function: silently keeps only one variant (first or last strategy).
(Optional) Validation Function: outright rejects checkout with a clear error instead of mutating the cart. (You can implement later.)
4. Important Distinction
Aspect	Theme	App (with Functions)
Runs in buyer browser	Yes	Partly (embedded scripts)
Server-side cart mutation or checkout blocking	No	Yes (Functions)
Needs deployment & CLI link to a Shopify app	No	Yes
Can be bypassed by API clients	Yes	Much harder (unless alternative APIs used deliberately)
5. Paths You Can Choose
A. Keep only theme JS (already done) – low effort, weakest enforcement.
B. Theme JS + Cart Transform Function (silent correction).
C. Theme JS + Validation Function (explicit error, no silent changes).
D. Combine Transform (auto-correct) + Validation (backstop) – strongest.

Recommended: Start with B (fast) then add C.

6. Tooling & Environment (Windows 11)
Prerequisites:

Node.js (LTS) – e.g. v18 or v20 (Shopify CLI supports active LTS).
Git installed & on PATH.
Shopify CLI (latest) installed (MSI or npm i -g @shopify/cli @shopify/app).
(Optional) Rust WASM toolchain NOT needed if using JavaScript runtime for Functions (what we’re doing). Older docs often reference Rust; we’re bypassing that by using JS runtime extensions.
Your Shopify partner account or store staff account with permissions; store in “development” or you have app dev rights.
Check versions:

7. High-Level Architecture for Enforcement App
Minimal custom app with:

/ app root (generated by CLI: Node or “empty” template).
single-delivery-date-cart-transform (move or recreate here).
(Later) /extensions/single-delivery-date-validation/ (order or checkout validation).
No need for UI, OAuth scopes minimal (Functions do not need write_products or similar unless you later add config UI).
8. Clean-Up Before Starting
In the theme repository right now, single-delivery-date-cart-transform is orphaned. Decide:

Option 1 (Recommended): Move that folder into a newly generated app project (outside the theme repo) and remove it from the theme repo to avoid confusion.
Option 2: Convert your current repo into a hybrid (theme + app). Not advised unless you want monorepo style.

9. Step-by-Step: Create & Deploy the App (Cart Transform)
9.1 Create App Skeleton (outside theme folder)
Pick a parent directory (e.g. C:\\Projects\\mrhenry-app):

(You can choose remix or php template if you prefer; node is fine.)

9.2 Copy / Recreate the Extension
Inside the new app folder:

CLI scaffolds a new folder under extensions.

Replace the generated index.js with our logic (or copy from the theme repo’s existing folder). Ensure:

shopify.function.extension.toml has type = "cart_transform" and correct api_version (e.g. 2024-07).
Product handle constant matches actual product handle (verify in Admin → product URL slug).
Example final index.js (keep-first strategy):

(If you want “keep latest” instead: iterate the cart lines in reverse and first encountered becomes keeper.)

9.3 Test Locally
From the app root:

Authenticate when prompted.
CLI spins up dev environment and registers draft function.
In your storefront (preview link output by CLI):

Add variant A to cart.
Add variant B (different date).
Refresh cart → only variant A should remain.
If the function isn’t running:

Verify extension appears under “Functions” in output.
Check that you’re hitting the dev preview domain provided (not the live store domain).
If using cart drawer with aggressive caching, trigger a full page reload after second add.
9.4 Deploy & Activate
Then go to Admin → Settings → Functions (or directly Apps > your app > Extensions) and assign/activate the Cart Transform extension to the store.

Production test:

Use live storefront (not preview) → attempt to add multiple date variants → confirm auto-prune.
9.5 Remove Redundant Theme Folder
Back in the theme repo, delete single-delivery-date-cart-transform (it no longer does anything theme-side). Or keep it with a README note: “Moved to app project; inert here.”

10. Adding a Validation Function (Optional Upgrade)
Why: Provide explicit error instead of silent removal (or as a backstop).
CLI:

Replace its index.js:

Deploy again:

Activate the validation function. Now if the transform somehow doesn’t run (or you disable it), checkout will still be blocked.

11. Configuration & Future Flexibility
If you anticipate changing the product handle seasonally:

Add a small Admin UI (embedded page) or use an app-level metafield to store the handle.
In the function, read input.shop.metafields (if exposed via input queries—requires editing shopify.function.extension.toml input section) to avoid code redeploys.
12. Testing Checklist
Scenario	Expected
Add Variant A only	Variant A remains
Add Variant A then B	B line removed (keep-first) OR A removed (if keep-latest strategy)
Rapid add B then A (fast clicks)	Only keeper after transform settles
Mixed date attempt then checkout	(With validation) checkout blocked or sanitized first
Non-target products added	Unaffected
JS disabled in browser	Server enforcement still works
Storefront API (GraphQL) mutation adding two variants	Transform still prunes final cart content
13. Front-End UX Alignment
Because Cart Transform is silent:

Keep theme warning (educates user).
Adjust message: “If a different date is added, we’ll keep only your first date. Please order again for another date.”
Optional: Add a small note under variant selector.
14. Logging / Observability
Functions can’t log to browser console. For debug:

During dev preview, intentionally create mixed cart and confirm transform operations by re-fetching /cart.js.
For deeper auditing in future, create an Admin app endpoint to store last transform decision (requires more infrastructure—optional).
15. Common Pitfalls (Windows)
Problem	Cause	Fix
CLI asks for Rust toolchain	You chose a template requiring a WASM build (e.g., older function runtime). Use JS runtime (what we did) or ignore message if not needed.	
Function doesn’t appear	Ran commands in theme repo, not app repo	Ensure you’re inside the app root folder
Transform not applied	Using live domain but only ran shopify app dev (not deployed)	Run shopify app deploy & activate
Mixed variants still present	Function handle mismatch	Check actual product handle slug in product admin
Validation always blocks	Product handle mis-typed so first line not captured	Console inspect merch.product.handle in dev mode (edit function temporarily to include debug removal ops)
16. Rollback Plan
If transform causes confusion:

Deactivate the function in Admin.
Keep theme JavaScript warning (still prevents most misuse).
Communicate policy in product description.
17. Definition of Done
App created & deployed.
Cart Transform active in Admin → Functions.
Attempt to add multiple date variants ends with a single date line.
(Optional) Validation Function blocks intentionally corrupted cart.
README / brief (this document) stored in repo root.
18. Quick Command Reference
19. If You Want Me to Do the Theme Auto-Sanitize Instead
(Already explained earlier) — ask for: “Add theme auto-sanitize keep-first” or “keep-latest” and I’ll patch custom.js.

TL;DR for Future Agent
Theme currently enforces rule only client-side.
Real enforcement requires an app because Functions run server-side.
Cart Transform extension created in theme repo is inert until migrated into an app and deployed.
Follow section 9 to spin up proper app; use section 10 to add validation if needed.